<%= javascript "ui.tabs.paging", "tabs", "doctors", "panels" %>

<fieldset class="<%= @accession.reported_at.blank? %>">
  <% if @accession.id %>
    <h1><%= t('.accession') %><%= @accession.id.to_s %></h1>
  <% end %>
  <%= form_for shallow_args(@patient, @accession), html: { novalidate: '' } do |f| %>
    <%= render 'shared/error_messages', object: @accession %>

    <h2><%= t('.order_details') %></h2>

    <div class="doctor_name">
      <%= f.label :doctor_name, t('.doctor') %>
      <%= f.text_field :doctor_name, placeholder: t('.walk_in'), autocorrect: 'off' %>
    </div>

    <div class="icd9">
      <%= f.label :icd9, t('.icd9') %>
      <%= f.text_field :icd9, placeholder: t('.icd9_placeholder'), autocorrect: 'off' %>
    </div>

    <div class="drawn_at">
    <% if mobile_user_agent? %>
      <%= f.label :drawn_at, t('.drawn_at') %>
      <%= f.datetime_ios_select :drawn_at, end_year: Time.now.year, value: @accession.drawn_at.try(:to_s, :w3cdtf) %>
    <% else %>
      <%= f.label :drawn_at, t('.drawn_at') %>
      <%= f.datetime_select :drawn_at, end_year: Time.now.year %>
    <% end %>
    </div>

    <div class="drawer_id">
      <%= f.label :drawer_id, t('.drawn_by') %>
      <%= f.collection_select :drawer_id, User.all, :id, :username %>
    </div>

    <div class="received_at">
    <% if mobile_user_agent? %>
      <%= f.label :received_at, t('.received_at') %>
      <%= f.datetime_ios_select :received_at, end_year: Time.now.year, value: @accession.received_at.try(:to_s, :w3cdtf) %>
    <% else %>
      <%= f.label :received_at, t('.received_at'), end_year: Time.now.year %>
      <%= f.datetime_select :received_at, end_year: Time.now.year %>
    <% end %>
    </div>

    <div class="receiver_id">
      <%= f.label :receiver_id, t('.received_by') %>
      <%= f.collection_select :receiver_id, User.all, :id, :username %>
    </div>

    <% if @accession.reported_at? %>
      <div class="reported_at">
      <% if mobile_user_agent? %>
        <%= f.label :reported_at, t('.reported_at') %>
        <%= f.datetime_ios_select :reported_at, end_year: Time.now.year, value: @accession.received_at.try(:to_s, :w3cdtf) %>
      <% else %>
        <%= f.label :reported_at, t('.reported_at') %>
        <%= f.datetime_select :reported_at, end_year: Time.now.year %>
      <% end %>
      </div>

      <div class="reporter_id">
        <%= f.label :reporter_id, t('.reported_by') %>
        <%= f.collection_select :reporter_id, User.all, :id, :username %>
      </div>
    <% end %>

    <h2><%= t('.order_panels') %></h2>

    <div id="panels">
      <%= f.collection_check_boxes(:panel_ids, Panel.sorted, :id, :name_with_description) do |b| %>
        <div class="panel">
          <%= b.check_box %>
          <%= b.label(class: 'checkbox') %>
        </div>
      <% end %>
    </div>

    <h2><%= t('.order_tests') %></h2>

    <div id="order_tests">
      <ul>
        <% for department in @departments %>
          <li><a href="#<%= department.id %>"><%= department.name %></a></li>
        <% end %>
      </ul>
      <% for department in @departments %>
        <div id="<%= department.id %>">
          <%= f.collection_check_boxes(:lab_test_ids, department.lab_tests, :id, :name_with_description) do |b| %>
            <div class="lab_test">
              <%= b.check_box %>
              <%= b.label(class: 'checkbox') %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="buttonbar">
      <%= f.submit t('.submit') %> <%= t('.or') %> 
      <% if @patient %>
        <%= link_to t('.cancel'), patient_accessions_path(@patient) %>
      <% else %>
        <%= link_to t('.cancel'), accession_path %>
      <% end %>
    </div>
  <% end %>
</fieldset>
